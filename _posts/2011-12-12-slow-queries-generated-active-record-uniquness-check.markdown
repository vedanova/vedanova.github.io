---
layout: post
status: publish
published: true
title: Slow queries generated by active record for uniquness check
author: admin
author_login: admin
author_email: you@yourdomain.com
wordpress_id: 274
wordpress_url: http://blog.vedanova.com/?p=274
date: 2011-12-12 13:36:00.000000000 +01:00
categories:
- rails
tags:
- active record
---
Just had to debug where one query that took up to 5 seconds on production came from. The query itself is following

    SELECT `users`.id FROM `users` WHERE (LOWER(`users`.`email`) = BINARY 'christoph@vedanova.com' AND `users`.id <> 68752) LIMIT 1

The problem with this query is, that is it is not using an index and it cannot use an index because of the "LOWER" statement.
The query was caused by the Active Record by the validates_uniqueness_of validation

    validates_uniqueness_of   :email, :case_sensitive => false

and is/was a long outstanding issue. Still in Rails 2.3.12 it is causing this query.

Credits go to <a href="http://techblog.floorplanner.com/2009/11/17/case-insensitive-validates_uniqueness_of-slowness/">Floorplanner</a>.

Here is the <a href="https://rails.lighthouseapp.com/projects/8994/tickets/2503-validates_uniqueness_of-is-horribly-inefficient-in-mysql">link</a> to the Lighthouse ticket.


